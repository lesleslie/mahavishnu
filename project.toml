# Buildpacks configuration for Mahavishnu orchestrator
# https://github.com/buildpacks/spec

# ==============================================================================
# Project Metadata
# ==============================================================================
[project]
id = "mahavishnu.orchestrator"
name = "Mahavishnu"
version = "0.1.0"

# ==============================================================================
# Build Configuration
# ==============================================================================
[[build.buildpacks]]
uri = "heroku/python"

[[build.buildpacks]]
uri = "heroku/procfile-explorer"

# ==============================================================================
# Python Environment
# ==============================================================================
[[build.env]]
name = "BP_PYTHON_VERSION"
value = "3.13"

[[build.env]]
name = "BP_PYTHON_INSTALL_NODE"
value = "false"

[[build.env]]
name = "BP_PYTHON_ENABLE_SYM_LINK"
value = "true"

# ==============================================================================
# OpenTelemetry Configuration
# ==============================================================================
[[build.env]]
name = "BP_OTEL_VERSION"
value = "latest"

[[build.env]]
name = "OTEL_SERVICE_NAME"
value = "mahavishnu"

[[build.env]]
name = "OTEL_SERVICE_VERSION"
value = "0.1.0"

[[build.env]]
name = "OTEL_EXPORTER_OTLP_PROTOCOL"
value = "grpc"

[[build.env]]
name = "OTEL_EXPORTER_OTLP_ENDPOINT"
value = "http://otel-collector:4317"

[[build.env]]
name = "OTEL_RESOURCE_ATTRIBUTES"
value = "service.name=mahavishnu,service.version=0.1.0,deployment.environment=production"

# Enable auto-instrumentation
[[build.env]]
name = "OTEL_PYTHON_AUTO_INSTRUMENTATION_ENABLED"
value = "true"

# ==============================================================================
# Dependencies Optimization
# ==============================================================================
[[build.env]]
name = "BP_KEEP_FILES_AT_BUILD"
value = "*.whl"

[[build.env]]
name = "BP_PIP_VERSION"
value = "latest"

# ==============================================================================
# Runtime Configuration
# ==============================================================================
[[build.env]]
name = "BP_LIVE_RELOAD_ENABLED"
value = "false"

[[build.env]]
name = "BP_DEBUG"
value = "false"

# ==============================================================================
# Web Server Configuration
# ==============================================================================
[[build.env]]
name = "BP_WEB_SERVER"
value = "uvicorn"

[[build.env]]
name = "BP_WEB_SERVER_MODULE"
value = "mahavishnu.mcp.server_core:app"

[[build.env]]
name = "BP_WEB_SERVER_CMD"
value = "mahavishnu mcp start"

# ==============================================================================
# Health Checks
# ==============================================================================
[[build.env]]
name = "BP_HEALTHCHECK"
value = "curl -f http://localhost:3035/health || exit 1"

[[build.env]]
name = "BP_HEALTHCHECK_INTERVAL"
value = "30"

[[build.env]]
name = "BP_HEALTHCHECK_TIMEOUT"
value = "5"

[[build.env]]
name = "BP_HEALTHCHECK_RETRIES"
value = "3"

[[build.env]]
name = "BP_HEALTHCHECK_START_PERIOD"
value = "10"

# ==============================================================================
# Process Types
# ==============================================================================
[[processes]]
type = "web"
command = "mahavishnu mcp start"
default = true

[[processes]]
type = "worker"
command = "mahavishnu workflow sweep --adapter prefect"

[[processes]]
type = "quality-check"
command = "mahavishnu qc run --all"

# ==============================================================================
# Developer Experience
# ==============================================================================
[[build.env]]
name = "BP_LAUNCH_DEBUG"
value = "true"

[[build.env]]
name = "BP_LOG_LEVEL"
value = "INFO"

# ==============================================================================
# Security Hardening
# ==============================================================================
[[build.env]]
name = "BP_RUN_IMAGE"
value = "full"

# Set non-root user
[[build.env]]
name = "BP_IMAGE_USERS"
value = "nonroot"

# Read-only root filesystem
[[build.env]]
name = "BP_READ_ONLY_ROOT_FILESYSTEM"
value = "true"

# ==============================================================================
# Metadata
# ==============================================================================
[metadata]
"description" = "Multi-engine orchestration platform for development workflows"
"org.opencontainers.image.title" = "Mahavishnu Orchestrator"
"org.opencontainers.image.description" = "Global orchestrator for managing workflows across multiple repositories"
"org.opencontainers.image.version" = "0.1.0"
"org.opencontainers.image.authors" = "Your Name <your.email@example.com>"
"org.opencontainers.image.documentation" = "https://github.com/yourusername/mahavishnu"
"org.opencontainers.image.source" = "https://github.com/yourusername/mahavishnu"

# ==============================================================================
# Development Configuration (Optional)
# ==============================================================================
# Uncomment for local development

# [[build.env]]
# name = "BP_DEBUG"
# value = "true"

# [[build.env]]
# name = "BP_LIVE_RELOAD_ENABLED"
# value = "true"

# [[build.env]]
# name = "BP_LOG_LEVEL"
# value = "DEBUG"
