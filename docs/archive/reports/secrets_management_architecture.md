# Secrets Management Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         MAHAVISHNU ECOSYSTEM                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Secrets Management System                     │   │
│  │                      (Integration #21)                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                     │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         SecretVault                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐     │   │
│  │  │   CRUD Ops   │  │   Rotation   │  │    Injection      │     │   │
│  │  │              │  │              │  │                   │     │   │
│  │  │ - Store      │  │ - Auto       │  │ - Env Var         │     │   │
│  │  │ - Retrieve   │  │ - Manual     │  │ - File Mount      │     │   │
│  │  │ - Update     │  │ - Verify     │  │ - Template        │     │   │
│  │  │ - Delete     │  │ - Rollback   │  │ - Dynamic Update  │     │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐     │   │
│  │  │   Scanning   │  │ Access Log   │  │      RBAC         │     │   │
│  │  │              │  │              │  │                   │     │   │
│  │  │ - Patterns   │  │ - Audit      │  │ - Read            │     │   │
│  │  │ - Detection  │  │ - History    │  │ - Write           │     │   │
│  │  │ - Reporting  │  │ - Analytics  │  │ - Delete          │     │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                     │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Storage Backends                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐     │   │
│  │  │    Local     │  │    Vault     │  │  Cloud Providers  │     │   │
│  │  │              │  │              │  │                   │     │   │
│  │  │ - SQLite     │  │ - HashiCorp  │  │ - AWS Secrets     │     │   │
│  │  │ - Encrypted  │  │ - KV v2      │  │ - Azure Key Vault │     │   │
│  │  │ - Versions   │  │ - Transit    │  │ - GCP Secret Mgr  │     │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                     │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Oneiric Integration                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐     │   │
│  │  │ Vault Layer  │  │ AWS Layer    │  │  Azure Layer      │     │   │
│  │  │              │  │              │  │                   │     │   │
│  │  │ MAHAVISHNU_  │  │ MAHAVISHNU_  │  │  MAHAVISHNU_      │     │   │
│  │  │ SECRETS__*   │  │ SECRETS__*   │  │  SECRETS__*       │     │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## Secret Lifecycle

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Create  │ ──▶ │  Store   │ ──▶ │ Retrieve │ ──▶ │  Rotate  │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
     │                │                │                │
     │                │                │                │
     ▼                ▼                ▼                ▼
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ Generate │     │ Encrypt  │     │ Decrypt  │     │  Verify  │
│   ID     │     │ AES-256  │     │ AES-256  │     │   Test   │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                          │
                                          ▼
                                    ┌──────────┐
                                    │  Delete  │
                                    └──────────┘
```

## Encryption Flow

```
┌──────────────────────────────────────────────────────────────┐
│                      Secret Encryption                        │
└──────────────────────────────────────────────────────────────┘

   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
   │  Value  │ ──▶ │  Salt   │ ──▶ │   KDF   │ ──▶ │   Key   │
   │ sk-...  │    │  Random │    │ PBKDF2  │    │ Derived │
   └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                              │
                                              ▼
   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
   │  Nonce  │ ──▶ │  AESGCM │ ──▶ │ Encrypt │ ──▶ │ Stored  │
   │  Random │    │         │    │  Value  │    │  Secret │
   └─────────┘    └─────────┘    └─────────┘    └─────────┘

   Master Key: 256-bit (32 bytes)
   Salt: 128-bit (16 bytes)
   Nonce: 96-bit (12 bytes)
   Algorithm: AES-256-GCM
```

## Secret Scanning

```
┌──────────────────────────────────────────────────────────────┐
│                     Secret Scanning                          │
└──────────────────────────────────────────────────────────────┘

   Repository
      │
      ▼
   ┌─────────┐    ┌─────────────┐    ┌──────────────┐
   │  Scan   │ ──▶ │   Match     │ ──▶ │    Report    │
   │  Files  │    │  Patterns   │    │  Findings    │
   └─────────┘    └─────────────┘    └──────────────┘
                         │
                         ▼
                   ┌─────────────┐
                   │ 50+ Patterns │
                   ├─────────────┤
                   │ API Keys     │
                   │ Passwords    │
                   │ SSH Keys     │
                   │ Tokens       │
                   │ Certificates │
                   └─────────────┘
```

## Access Logging

```
┌──────────────────────────────────────────────────────────────┐
│                     Access Logging                           │
└──────────────────────────────────────────────────────────────┘

   ┌─────────┐    ┌─────────────┐    ┌──────────────┐
   │  User   │ ──▶ │   Action    │ ──▶ │   Log Entry  │
   │ Request │    │ (CRUD)      │    │              │
   └─────────┘    └─────────────┘    └──────────────┘
                                             │
                                             ▼
                                   ┌──────────────────┐
                                   │  Audit Trail     │
                                   │  ┌──────────┐    │
                                   │  │ Timestamp │    │
                                   │  │ User      │    │
                                   │  │ Action    │    │
                                   │  │ IP        │    │
                                   │  │ Success   │    │
                                   │  └──────────┘    │
                                   └──────────────────┘
```

## Integration Points

```
┌───────────────────────────────────────────────────────────────────┐
│                     Mahavishnu Ecosystem                          │
└───────────────────────────────────────────────────────────────────┘

                          Secrets Management
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
         ▼                       ▼                       ▼
   ┌─────────┐             ┌─────────┐             ┌─────────┐
   │ Oneiric │             │ Session │             │Crackerjack│
   │ Config  │             │ Buddy  │             │    QC    │
   └─────────┘             └─────────┘             └─────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
   ┌─────────┐             ┌─────────┐             ┌─────────┐
   │ Secrets │             │ Storage │             │ Scanning │
   │ Layer   │             │ Backend │             │  QC     │
   └─────────┘             └─────────┘             └─────────┘
```

## Security Layers

```
┌──────────────────────────────────────────────────────────────┐
│                    Defense in Depth                           │
└──────────────────────────────────────────────────────────────┘

   Layer 1: Encryption (AES-256-GCM)
      │
      ▼
   Layer 2: Key Derivation (PBKDF2, 100k iterations)
      │
      ▼
   Layer 3: Access Control (RBAC)
      │
      ▼
   Layer 4: Audit Logging (Complete trail)
      │
      ▼
   Layer 5: Network Security (TLS, mTLS)
```

## Compliance Mapping

```
┌──────────────────────────────────────────────────────────────┐
│                    Compliance Mapping                         │
└──────────────────────────────────────────────────────────────┘

   SOC2                HIPAA               PCI-DSS
   ┌─────┐            ┌─────┐            ┌─────┐
   │ CC  │            │  PHI │            │  CHQ │
   │  6.1│ ──────────▶ │ Cont│ ──────────▶ │ Req │
   │  6.6│            │ rrol│            │  3  │
   │  6.7│            │     │            │     │
   │  7.2│            │     │            │     │
   └─────┘            └─────┘            └─────┘
      │                    │                    │
      └────────────────────┴────────────────────┘
                           │
                           ▼
                  Secrets Management
                  ┌──────────────────┐
                  │ Encryption       │
                  │ Access Control   │
                  │ Audit Logging    │
                  │ Rotation         │
                  └──────────────────┘
```
